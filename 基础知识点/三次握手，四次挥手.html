<html>
<head>
  <title>三次握手，四次挥手</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/272632; Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="854"/>
<h1>三次握手，四次挥手</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><br style="margin:0px; padding:0px"/></p><div style="margin:0px; padding:0px; border:0px; color:rgb(74,74,74); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; background-color:rgb(245,245,245)"><span style="margin:0px; padding:0px; color:rgb(0,51,153)">所谓三次握手(Three-way Handshake)，是指建立一个TCP连接时，需要客户端和服务器总共发送3个包。</span></div><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; color:rgb(0,51,153)">三次握手的目的是连接服务器指定端口，建立TCP连接,并同步连接双方的序列号和确认号并交换 TCP 窗口大小信息.在socket编程中，客户端执行connect()时。将触发三次握手。</span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><img src="三次握手，四次挥手_files/Image.png" type="image/png" style="cursor: default;cursor: default;cursor: default;"/></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; color:rgb(0,51,153)">第一次握手:</span><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; color:rgb(0,51,153)">客户端发送一个TCP的SYN标志位置1的包指明客户打算连接的服务器的端口，以及初始序号X,保存在包头的序列号(Sequence Number)字段里。</span></p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 8px; padding-bottom: 8px; text-align: justify; color: rgb(74, 74, 74); background-color: rgb(253, 253, 253);"><img src="三次握手，四次挥手_files/Image [1].png" type="image/png" style="cursor: default;"/></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; color:rgb(0,51,153)">第二次握手:</span><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; color:rgb(0,51,153)">服务器发回确认包(ACK)应答。即SYN标志位和ACK标志位均为1同时，将确认序号(Acknowledgement Number)设置为客户的I S N加1以.即X+1。</span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px"><img src="三次握手，四次挥手_files/Image [2].png" type="image/png" style="cursor: default;cursor: default;cursor: default;"/><br style="margin:0px; padding:0px"/></span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; color:rgb(0,51,153)">第三次握手:</span><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px; color:rgb(0,51,153)">客户端再次发送确认包(ACK) SYN标志位为0,ACK标志位为1.并且把服务器发来ACK的序号字段+1,放在确定字段中发送给对方.并且在数据段放写ISN的+1</span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px"><img src="三次握手，四次挥手_files/Image [3].png" type="image/png" style="cursor: default;cursor: default;cursor: default;"/><br style="margin:0px; padding:0px"/></span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px"><span style="margin:0px; padding:0px; color:rgb(0,51,153)">TCP的连接的拆除需要发送四个包，因此称为四次挥手(four-way handshake)。客户端或服务器均可主动发起挥手动作，在socket编程中，任何一方执行close()操作即可产生挥手操作。</span></span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><span style="margin:0px; padding:0px; background-color:rgb(245,245,245); font-family:&apos;Helvetica Neue&apos;,Helvetica,Arial,sans-serif; font-size:13px; line-height:19px"><img src="三次握手，四次挥手_files/Image.jpg" type="image/jpeg" style="cursor: default;cursor: default;cursor: default;"/><br style="margin:0px; padding:0px"/></span><span style="margin:0px; padding:0px; color:rgb(0,51,153)">由于TCP连 接时全双工的，因此，每个方向都必须要单独进行关闭，这一原则是当一方完成数据发送任务后，发送一个FIN来终止这一方向的连接，收到一个FIN只是意味 着这一方向上没有数据流动了，即不会再收到数据了，但是在这个TCP连接上仍然能够发送数据，直到这一方向也发送了FIN。首先进行关闭的一方将执行主动 关闭，而另一方则执行被动关闭，上图描述的即是如此。</span><br style="margin:0px; padding:0px"/><span style="margin:0px; padding:0px; color:rgb(0,51,153)">（1）第一次挥手：Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。</span><br style="margin:0px; padding:0px"/><span style="margin:0px; padding:0px; color:rgb(0,51,153)">（2）第二次挥手：Server收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态。</span><br style="margin:0px; padding:0px"/><span style="margin:0px; padding:0px; color:rgb(0,51,153)">（3）第三次挥手：Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。</span><br style="margin:0px; padding:0px"/><span style="margin:0px; padding:0px; color:rgb(0,51,153)">（4）第四次挥手：Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手。</span><br style="margin:0px; padding:0px"/><span style="margin:0px; padding:0px; color:rgb(0,51,153)">上面是一方主动关闭，另一方被动关闭的情况，实际中还会出现同时发起主动关闭的情况，具体流程如下图：</span></p><p style="margin-top:0px; margin-bottom:0px; padding-top:8px; padding-bottom:8px; text-align:justify; color:rgb(74,74,74); font-family:&apos;Microsoft YaHei&apos;,΢���ź�,tahoma,arial,simsun,sans-serif; font-size:14px; line-height:28px; background-color:rgb(253,253,253)"><img src="三次握手，四次挥手_files/Image [4].png" type="image/png" style="cursor: default;cursor: default;cursor: default;"/></p></div>
</div></body></html> 